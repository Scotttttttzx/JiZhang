<!--index.wxml-->
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <view class="userinfo">
      <block wx:if="{{canIUseNicknameComp && !hasUserInfo}}">
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" src="{{userInfo.avatarUrl}}"></image>
        </button>
        <view class="nickname-wrapper">
          <text class="nickname-label">æ˜µç§°</text>
          <input type="nickname" class="nickname-input" placeholder="è¯·è¾“å…¥æ˜µç§°" bind:change="onInputChange" />
        </view>
      </block>
      <block wx:elif="{{!hasUserInfo}}">
        <button wx:if="{{canIUseGetUserProfile}}" bindtap="getUserProfile"> è·å–å¤´åƒæ˜µç§° </button>
        <view wx:else> è¯·ä½¿ç”¨2.10.4åŠä»¥ä¸Šç‰ˆæœ¬åŸºç¡€åº“ </view>
      </block>
      <block wx:else>
        <image bindtap="bindViewTap" class="userinfo-avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
        <text class="userinfo-nickname">{{userInfo.nickName}}</text>
      </block>
    </view>
    <view class="usermotto">
      <text class="user-motto">{{motto}}</text>
    </view>
  </view>
</scroll-view>

<!-- ä¸»ç•Œé¢ -->
<view class="main-container">
  <!-- é¡¶éƒ¨å¡ç‰‡ -->
  <view class="top-card">
    <view class="top-card-header">
      <view class="date-text">{{year}}å¹´{{month}}æœˆ</view>
    </view>
    <view class="divider"></view>
    <view class="balance-row">
      <text class="balance-label">æœ¬æœˆç»“ä½™</text>
      <text class="balance-value">{{balance}}</text>
    </view>
    <view class="summary-row">
      <view class="summary-item">
        <text class="summary-label">æœ¬æœˆæ”¯å‡º</text>
        <text class="summary-value out">-{{expense}}</text>
      </view>
      <view class="summary-item">
        <text class="summary-label">æœ¬æœˆæ”¶å…¥</text>
        <text class="summary-value in">{{income}}</text>
      </view>
      <view class="summary-item">
        <text class="summary-label">å‰©ä½™é¢„ç®—</text>
        <text class="summary-value">{{budget}}</text>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
  <view class="feature-row">
    <view class="feature-btn" bindtap="onAIAnalysis">
      <image class="feature-icon" src="/images/ai.png" />
      <text>aiè´¦å•åˆ†æ</text>
    </view>
    <view class="feature-btn" bindtap="onAccount">
      <image class="feature-icon" src="/images/account.png" />
      <text>èµ„äº§è´¦æˆ·</text>
    </view>
    <view class="feature-btn" bindtap="onBudget">
      <image class="feature-icon" src="/images/budget.png" />
      <text>é¢„ç®—</text>
    </view>
    <view class="feature-btn" bindtap="onTodayDetail">
      <image class="feature-icon" src="/images/today.png" />
      <text>ä»Šæ—¥æ˜ç»†</text>
    </view>
  </view>

  <!-- æ”¶æ”¯è®°å½•åŒº -->
  <view class="record-header">
    <text>æ”¶æ”¯è®°å½•</text>
    <view class="header-actions">
      <text class="add-record" bindtap="onAddRecord">+ è®°ä¸€ç¬”</text>
      <view class="debug-btn" bindtap="debugData" wx:if="{{displayRecords.length === 0}}">
        <text class="debug-icon">ğŸ”</text>
        <text class="debug-text">è°ƒè¯•</text>
      </view>
    </view>
  </view>
  <view class="record-list">
    <block wx:if="{{displayRecords.length === 0}}">
      <view class="no-record">æœ¬æœˆæš‚æ— è®°å½•</view>
      <button class="start-btn" bindtap="onAddRecord">å¼€å§‹è®°è´¦</button>
    </block>
    <block wx:else>
      <view class="record-item" wx:for="{{displayRecords}}" wx:key="id">
        <view class="record-left">
          <text class="record-icon">{{item.category.icon}}</text>
          <view class="record-info">
            <text class="record-category">{{item.category.name}}</text>
            <text class="record-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
            <text class="record-time">{{item.date}} {{item.time}}</text>
          </view>
        </view>
        <view class="record-right">
          <text class="record-amount {{item.type === 'expense' ? 'out' : 'in'}}">
            {{item.type === 'expense' ? '-' : '+'}}{{item.amount}}
          </text>
          <view class="delete-btn" catchtap="onDeleteRecord" data-record="{{item}}">
            <text class="delete-icon">ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view class="load-more" wx:if="{{hasMore || isLoading}}">
        <view wx:if="{{isLoading}}" class="loading">
          <view class="loading-icon"></view>
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
        <view wx:elif="{{hasMore}}" class="load-more-btn" bindtap="loadMoreRecords">
          <text>ç‚¹å‡»åŠ è½½æ›´å¤š</text>
        </view>
      </view>
      
      <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
      <view class="no-more" wx:if="{{!hasMore && displayRecords.length > 0}}">
        <text>å·²æ˜¾ç¤ºå…¨éƒ¨è®°å½• ({{displayRecords.length}}æ¡)</text>
      </view>
    </block>
  </view>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <view class="tabbar">
    <view class="tabbar-item" bindtap="onCalendar">
      <image src="/images/calendar.png" class="tabbar-icon" />
      <text>æ—¥å†</text>
    </view>
    <view class="tabbar-item" bindtap="onStatistics">
      <image src="/images/statistics.png" class="tabbar-icon" />
      <text>ç»Ÿè®¡</text>
    </view>
    <view class="tabbar-item add-btn" bindtap="onAddRecord">
      <view class="add-circle">+</view>
    </view>
    <view class="tabbar-item" bindtap="onSaving">
      <image src="/images/saving.png" class="tabbar-icon" />
      <text>å­˜é’±</text>
    </view>
    <view class="tabbar-item" bindtap="onMine">
      <image src="/images/mine.png" class="tabbar-icon" />
      <text>æˆ‘çš„</text>
    </view>
  </view>

  <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
  <view class="back-to-top" bindtap="scrollToTop" wx:if="{{displayRecords.length > 10}}">
    <text class="back-to-top-icon">â†‘</text>
  </view>
</view>
